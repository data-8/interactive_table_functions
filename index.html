<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<title>Data 8 Tables Visualizer</title>
		<link rel="stylesheet" type="text/css" href="./tables_files/bootstrap.css">

		<link rel="stylesheet" type="text/css" href="./tables_files/stylesheet.css">
		<script type="text/javascript" language="javascript" src="./tables_files/jquery-3.3.1.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	</head>
	<body>
		<div class="row text-center">
			<div class="col-md-1"></div>
			<div class="col-md-10">
				<h1>
					<p>Data 8 Table Function Visualizer<p>
				</h1>
			</div>
			<div class="col-md-1" ></div>
		</div>
		<div class="container">
			<ul class="nav nav-tabs" id="nav">
		    <li class="nav-item">
		        <a href="#group-tab" class="nav-link active" data-toggle="tab">Group</a>
		    </li>
		    <li class="nav-item">
		        <a href="#pivot-tab" class="nav-link" data-toggle="tab">Pivot</a>
		    </li>
				<!--
		    <li class="nav-item">
		        <a href="#join-tab" class="nav-link" data-toggle="tab">Join</a>
		    </li> -->
			</ul>
			<div class="tab-content">
			    <div class="tab-pane active" id="group-tab">
					<div class="row">
						<div class="col-lg-12 text-center">
							<form id="target-group">
								<div class="form-group">
									<div class="row text-center align-items-center">
										<div class="col-auto">
											<select class="form-control" id="group-dataset" aria-label="Select dataset">
												<option>cones</option>
												<option>chocolates</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">.group(</span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="group-column" aria-label="Column to group by">
												<option>"Flavor"</option>
												<option>"Price"</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">, </span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="group-function" aria-label="Aggregation function">
												<option>no function (count)</option>
												<option>np.average</option>
												<option>np.mean</option>
												<option>sum</option>
												<option>min</option>
												<option>max</option>
												<option>identity</option>
												<option>first</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">)</span>
										</div>
										<div class="col-auto">
											<button type="submit" class="btn btn-primary">Visualize!</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
			    </div>
			    <div class="tab-pane" id="pivot-tab">
					<div class="row">
						<div class="col-lg-12 text-center">
							<form id="target-pivot">
								<div class="form-group">
									<div class="row text-center align-items-center">
										<div class="col-auto">
											<select class="form-control" id="pivot-dataset" aria-label="Select dataset">
												<option>cones</option>
												<option>chocolates</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">.pivot(</span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="pivot-column-1" aria-label="Pivot column">
												<option>"Flavor"</option>
												<option>"Price"</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">, </span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="pivot-column-2" aria-label="Rows column">
												<option>"Flavor"</option>
												<option>"Price"</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">, </span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="pivot-column-3" aria-label="Values column">
												<option>no argument</option>
												<option>"Flavor"</option>
												<option>"Price"</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">, </span>
										</div>
										<div class="col-auto">
											<select class="form-control" id="pivot-function" aria-label="Aggregation function">
												<option>no function (count)</option>
												<option>np.average</option>
												<option>np.mean</option>
												<option>sum</option>
												<option>min</option>
												<option>max</option>
												<option>identity</option>
												<option>first</option>
											</select>
										</div>
										<div class="col-auto">
											<span class="h4 mb-0">)</span>
										</div>
										<div class="col-auto">
											<button type="submit" class="btn btn-primary">Visualize!</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
			    </div>
			    <div class="tab-pane" id="join-tab">
						<div class="row">
							<div class="col-lg-12 text-center">
								<form id="target-join">
									<div class="form-group">
										<div class="row text-center">
											<div class="col-sm-2">
												<select class="form-control" id="join-dataset">
													<option>cones</option>
													<option>chocolates</option>
												</select>
											</div>
											<div class="col-xs-8 text-left" id="join-text">
												<h2>.join("Flavor", ratings, "Flavor")</h2>
											</div>
											<div class="col-md-2">
												<button type="submit" class="btn btn-primary">Visualize!</button>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
			    </div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h2 id="code"></h2>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6">
					<table id="original" class="table table-striped table-bordered" style="width:100%">
						<caption>cones</caption>
						<thead>
							<tr>
								<th>Flavor</th>
								<th>Price</th>
								</tr>
						</thead>
						<tbody>
							<tr>
								<td>Strawberry</td>
								<td>3.55</td>
							</tr>
							<tr>
								<td>Chocolate</td>
								<td>4.75</td>
							</tr>
							<tr>
								<td>Chocolate</td>
								<td>6.55</td>
							</tr>
							<tr>
								<td>Strawberry</td>
								<td>5.25</td>
							</tr>
							<tr>
								<td>Chocolate</td>
								<td>5.25</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="col-lg-6">
					<table id="grouped" class="table table-striped table-bordered" style="width:100%">
						<caption>chocolates</caption>
						<thead>
							<tr>
								<th>Color</th>
								<th>Shape</th>
								<th>Amount</th>
								<th>Price</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Dark</td>
								<td>Round</td>
								<td>4</td>
								<td>1.3</td>
							</tr>
							<tr>
								<td>Milk</td>
								<td>Rectangular</td>
								<td>6</td>
								<td>1.2</td>
							</tr>
							<tr>
								<td>White</td>
								<td>Rectangular</td>
								<td>12</td>
								<td>2</td>
							</tr>
							<tr>
								<td>Dark</td>
								<td>Round</td>
								<td>7</td>
								<td>1.75</td>
							</tr>
							<tr>
								<td>Milk</td>
								<td>Rectangular</td>
								<td>9</td>
								<td>1.4</td>
							</tr>
							<tr>
								<td>Milk</td>
								<td>Round</td>
								<td>2</td>
								<td>1</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12 text-center" id="control" style="display: none;">
					<h2 id="text"> &nbsp; </h2>
					<button type="button" class="btn btn-danger" id="back" aria-label="Go to previous step">< Previous Step</button>
  				<button type="button" class="btn btn-success" id="next" aria-label="Go to next step">Next Step ></button>
					<button type="button" class="btn btn-primary" id="reload-button" aria-label="Start a new visualization">New Visualization</button>
				</div>
			</div>
		</div>
		<div class= "text-center">
			<p>Inspired by <a target="_blank" href="http://pythontutor.com/visualize.html"><b>Python Tutor</b></a> (created by <a target="_blank" href="http://pgbovine.net/">Philip Guo</a>) and visualizations created by Divyesh Chotai. Created by Yanay Rosen. This is a Beta.</p>
			<img src="./tables_files/full_logo_final.png" alt="Data 8 Logo" style="height:3em;">
		</div>

	</body>
	<script type="text/javascript">
		// our first table
		var datasets = {"cones": {"data":{"Flavor":["Strawberry", "Chocolate", "Chocolate", "Strawberry", "Chocolate"], "Price":[3.55, 4.75, 6.55, 5.25, 5.25]}, "col_order":["Flavor", "Price"], "join-data":{"Kind":["Strawberry", "Chocolate", "Vanilla"], "Stars":[2.5, 3.5, 4]}, "join-cols":["Flavor", "Kind"], "join-name":"ratings"},
			"chocolates":{"data":{"Color":["Dark", "Milk", "White", "Dark", "Milk", "Milk"], "Shape":["Round", "Rectangular", "Rectangular", "Round", "Rectangular", "Round"],"Amount":[4,6,12,7,9,2],"Price":[1.3,1.2,2.0,1.75,1.4,1.0]}, "col_order":["Color", "Shape", "Amount", "Price"], "join-data":{"Shape":["Round", "Round", "Rectangular", "Triangular"], "Weight":[3.1, 4.25, 3,6, 2.9]}, "join-cols":["Shape", "Shape"], "join-name":"weights"}
		}
		var data;

	// Smart sort function that handles both numbers and strings
	function smartSort(arr) {
		// Check if first element is a number
		if (arr.length > 0 && typeof arr[0] === 'number') {
			// Numeric sort
			return arr.sort(function(a, b) { return a - b; });
		} else {
			// String sort (lexicographic)
			return arr.sort();
		}
	}

	// Helper function to format array values (adds quotes around strings)
	function formatArrayValues(arr) {
		return arr.map(function(val) {
			if (typeof val === 'string') {
				return '"' + val + '"';
			}
			return val;
		}).join(", ");
	}

	// group function
		function group(dataset, column, func_name) {
			var states = [];
			var data = dataset["data"];
			// phase one is generate the new table with columns and rows
			var columns = Object.keys(data);
			if (func_name === "count") {
				var new_columns = [column, "count"];
				// highlight the group column in original table
				var state = {"o_col_h":[dataset["col_order"].indexOf(column)]};
				states.push(state);
				// say default is to count and add column to new table
				var n_data = {};
				n_data[column] = [];
				n_data["count"] = [];
				var ordered = new_columns;
				state = {"n_data":JSON.parse(JSON.stringify(n_data)), "text":"By default, group will count the number of rows with unique values", "n_col_h":JSON.parse(JSON.stringify([1])), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
				states.push(state);
			} else {
				// highlight the group column in original table
				var state = {"o_col_h":[dataset["col_order"].indexOf(column)]};
				states.push(state);
				// add the original column to the table
				var n_data = {};
				n_data[column] = [];
				state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_h":[0], "n_col_ord":[column]};
				states.push(state);

				var rest_of_columns = columns.filter(function(x) {
					return x !== column;
				});
				var new_columns = [column] + rest_of_columns.map(x => x + " " + func_name)
				// highlight the column names in original table
				var ordered = [column];
				var n_data = {};
				n_data[column] = [];
				rest_of_columns.forEach((item, i) => {
					// highlight the specific column in original table and highlight the function name
					var new_col_name = item + " " + func_name;
					var state = {"o_col_h":[dataset["col_order"].indexOf(item)], "command_h":"func", "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
					states.push(state);
					// add the new column to the table
					n_data[new_col_name] = [];
					ordered.push(new_col_name);
					state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_h":[1+i], "n_col_ord":JSON.parse(JSON.stringify(ordered))};
					states.push(state);
				});
			}
		// phase two is get unique values
		var uniq = smartSort(Array.from(new Set(data[column])));
		// highlight the group column in original table
		// display the uniq values of text
		var unique_str = "Unique values (sorted): [" + Array.from(uniq).join(', ') + "]";
		var state = {"o_col_h":[dataset["col_order"].indexOf(column)], "text":unique_str, "n_col_ord":JSON.parse(JSON.stringify(ordered)), "n_data":JSON.parse(JSON.stringify(n_data))};
			states.push(state);

			// phase three is step through the original table and generate the arrays
			var n_data_real = JSON.parse(JSON.stringify(n_data));
			uniq.forEach((item, i) => {
				// highlight the items in original table and add value to column
				var idx_to_highlight = data[column].map(function(x, j) {return j}).filter(function(x) {
					return data[column][x] === item;
				});
				// highlight all the rows and add the value to the new table
				n_data[column].push(item);
				n_data_real[column].push(item);
				var state = {"o_row_h":JSON.parse(JSON.stringify(idx_to_highlight)), "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
				states.push(state);

				if (func_name === "count") {
					var new_columns = [column, "count"];
					// set the value in grouped count column to num rows
					var num = idx_to_highlight.length;
					// add the num to the state
					n_data["count"].push(num);
					var state = {"o_row_h":JSON.parse(JSON.stringify(idx_to_highlight)), "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
					states.push(state);

				} else {
					columns.forEach((item, i) => {
						if (item == column) {
							return;
						}
					// highlight the specific column in original table and highlight the row values
					var cell_highlights = [];
					var cell_values = [];
					var new_col_name = item + " " + func_name;
					idx_to_highlight.forEach((value, j) => {
							// step through the rest of the columns
							var cell = [value, i];
							cell_highlights.push(cell);
							cell_values.push(data[item][value]);
					});
				n_data[new_col_name].push("[" + formatArrayValues(cell_values) +"]");
					var real_value;
				if (func_name === "sum") {
					real_value = cell_values.reduce((a, b) => a +b, 0);
				} else if (func_name === "average" || func_name === "mean") {
					real_value = cell_values.reduce((a, b) => a +b, 0) / cell_values.length;
				} else if (func_name === "first") {
					real_value = cell_values[0];
				} else if (func_name === "identity") {
					real_value = "[" + formatArrayValues(cell_values) +"]"
				} else if (func_name === "max") {
						if (typeof cell_values[0] === "string") {
							real_value = cell_values.reduce((a, b) => a > b ? a : b);
						} else {
							real_value = Math.max.apply(null, cell_values);
						}
					} else if (func_name === "min") {
						if (typeof cell_values[0] === "string") {
							real_value = cell_values.reduce((a, b) => a < b ? a : b);
						} else {
							real_value = Math.min.apply(null, cell_values);
						}
					}

					// Only sum, average, and mean don't work on strings
					if ((func_name === "sum" || func_name === "average" || func_name === "mean") && typeof cell_values[0] === "string") {
						real_value = "";
					}
						n_data_real[new_col_name].push(real_value);
						var state = {"o_col_h":[dataset["col_order"].indexOf(item)], "o_row_h":JSON.parse(JSON.stringify(idx_to_highlight)), "o_cell_h":JSON.parse(JSON.stringify(cell_highlights)), "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
						states.push(state);
					});

				}
			});

			if (func_name !== "count") {
				// highlight the func name
				var state = {"command_h":"func", "text":"Call the function on Arrays", "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered)), "display_with_function":true};
				states.push(state);
				var state = {"n_data":JSON.parse(JSON.stringify(n_data_real)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
				states.push(state);
			} else {
				var state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
				states.push(state);
			}


			return states
		}

	function pivot(data, pivot_column, group_column, collect_column, func_name) {
		var o_ordered = data["col_order"];
		var data = data["data"]
		var states = [];
		// phase one is generate the new table with columns and rows
		var original_columns = Object.keys(data);
		var pivot_uniq = smartSort(Array.from(new Set(data[pivot_column])));
		var group_uniq = smartSort(Array.from(new Set(data[group_column])));
			var new_columns = [group_column].concat(pivot_uniq);
			// display the new columns

		var states = [];
		// highlight the pivot column
		var state = {"o_col_h":[o_ordered.indexOf(pivot_column)], "text":"Unique Value(s) in Pivot Column (sorted): [" + pivot_uniq.join(", ") + "]"};
			states.push(state);

			var n_data = {};
			new_columns.forEach((item, i) => {
				n_data[item] = [];
			});

			// add the columns
			var ordered = new_columns;
			state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
			states.push(state);


		// add the rows
		n_data[group_column] = JSON.parse(JSON.stringify(group_uniq));
		state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered)), text:"Unique Value(s) in group column (sorted): [" + group_uniq.join(", ") + "]", "o_col_h":[o_ordered.indexOf(group_column)]};
			states.push(state);

			// iterate through the pairings highlighting the pivot column and row value, the group column and row value in n
			// if there is a specified column then highlight that column in o and the cell value
			// if func is count put zeros everywhere
			data[group_column].forEach(function(grouped_value, i) {
				// highlight the row, highlight the two columns in new
				pivot_uniq.forEach((pivot_value, i) => {
					var group_index = group_uniq.indexOf(grouped_value);
					if (func_name === "count") {
						n_data = JSON.parse(JSON.stringify(n_data));
						n_data[pivot_value][group_index] = 0;
					} else {
						//if its a function use arrays and highlight the column
						n_data[pivot_value][group_index] = [];
					}
				});


			});

			// iterate through every row

			data[group_column].forEach(function(grouped_value, i) {
				// highlight the row, highlight the two columns in new
				var pivot_value = data[pivot_column][i];
				var group_index = group_uniq.indexOf(grouped_value);
				var pivot_index = pivot_uniq.indexOf(pivot_value);
				state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered)), "o_row_h":[i], "n_col_h":[pivot_index + 1], "n_row_h":[group_index]};
				if (func_name !== "count") {
					state["o_col_h"] = [o_ordered.indexOf(collect_column)];
					state["display_as_arrays"] = true;
				} else {
					state["text"] = "By Default, pivot counts how often each pair occurs.";
				}

				states.push(state);
				// if its counts use a counter
				if (func_name === "count") {
					n_data = JSON.parse(JSON.stringify(n_data));
					n_data[pivot_value][group_index] = n_data[pivot_value][group_index] + 1;
					state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered)), "o_row_h":[i], "n_col_h":[pivot_index + 1], "n_row_h":[group_index], "text":"By Default, pivot counts how often each pair occurs."};
					state["n_cell_h"] = [[group_index, pivot_index + 1]];
					states.push(state);
				} else {
					//if its a function use arrays and highlight the column
					var new_value = data[collect_column][i];
					n_data[pivot_value][group_index] = JSON.parse(JSON.stringify(n_data[pivot_value][group_index])).concat([new_value])
					state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered)), "o_row_h":[i], "n_col_h":[pivot_index + 1], "n_row_h":[group_index], "n_cell_h":[group_index, pivot_index+1]};
					state["o_col_h"] = [o_ordered.indexOf(collect_column)];
					state["o_cell_h"] = [[i, o_ordered.indexOf(collect_column)]];
					state["n_cell_h"] = [[group_index, pivot_index + 1]];
					state["display_as_arrays"] = true;

				}

			});


		// finally, call the function if needed on arrays
		if (func_name !== "count") {
				// Check the data type of the collect column
				var collect_column_type = typeof data[collect_column][0];
				var func_works_on_type = true;
				if ((func_name === "sum" || func_name === "average" || func_name === "mean") && collect_column_type === "string") {
					func_works_on_type = false;
				}
				
				var state = {"command_h":"func", "text":"Call the function on Arrays", "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
				state["display_with_function"] = true;
				state["display_as_arrays"] = true;
				states.push(state);
				n_data = JSON.parse(JSON.stringify(n_data));
				pivot_uniq.forEach((pivot_col, i) => {
					all_values = n_data[pivot_col];
					all_values = all_values.map(function(cell_values) {
					// If function doesn't work on this data type, always return "None"
					if (!func_works_on_type) {
						return "None";
					}
					
					// If no data for this combination, return empty string
					if (cell_values.length === 0) {
						return "";
					}
					
					var real_value;
					if (func_name === "sum") {
						real_value = cell_values.reduce((a, b) => a +b, 0);
					} else if (func_name === "average" || func_name === "mean") {
						real_value = cell_values.reduce((a, b) => a +b, 0) / cell_values.length;

					} else if (func_name === "first") {
						real_value = cell_values[0];
					} else if (func_name === "identity") {
						real_value = "[" + formatArrayValues(cell_values) +"]"
					} else if (func_name === "max") {
							if (typeof cell_values[0] === "string") {
								real_value = cell_values.reduce((a, b) => a > b ? a : b);
							} else {
								real_value = Math.max.apply(null, cell_values);
							}
						} else if (func_name === "min") {
							if (typeof cell_values[0] === "string") {
								real_value = cell_values.reduce((a, b) => a < b ? a : b);
							} else {
								real_value = Math.min.apply(null, cell_values);
							}
					}

				// Handle edge cases (shouldn't happen since we check type earlier)
				if (real_value !== real_value || real_value === null || real_value === undefined) {
					real_value = "";
				}
						return real_value;
						});

						n_data[pivot_col] = JSON.parse(JSON.stringify(all_values));
					});

					var state = {"command_h":"func", "text":"Call the function on Arrays", "n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};

					states.push(state);
				};
			var state = {"n_data":JSON.parse(JSON.stringify(n_data)), "n_col_ord":JSON.parse(JSON.stringify(ordered))};
			states.push(state);
			return states
		}


		var states = [];
		var cur_state_idx = -1;
		var cur_state;
		var header_text;
		var func_name_original;
		var pre_head_text;
		var post_head_text;


		$("#target-group" ).submit(function( event ) {
			$("#grouped").empty();
			$('#original').empty();
			var col_name = $('#group-column').val();
			var func_name = $('#group-function').val();
			func_name_original = $('#group-function').val();
			if (func_name === "np.average") {
				func_name = "average";
			}

			if (func_name === "np.mean") {
				func_name = "mean";
			}

			if (func_name === "no function (count)") {
				func_name = "count";
			}

			var dataset_val = $('#group-dataset').val();
			data = datasets[dataset_val]["data"];
			var dataset_col_order = datasets[dataset_val]["col_order"];
			// build original table from the rows and values

			var ths = dataset_col_order.map(function(x) {
				return "<th>" + x + "</th>"
			}).join("\n");

			var trs = data[dataset_col_order[0]].map(function(item, j) {
				var tds = dataset_col_order.map(function(i) {
					return "<td>" + data[i][j] + "</td>"
				}).join("\n");
				return "<tr>\n" + tds + "\n</tr>";
			}).join("\n");

			var htmlString = "<table><thead><tr>" + ths + "</tr><thead><tbody>" + trs + "<tbody><table";
			$("#original").html(htmlString);

			states = group(datasets[dataset_val], col_name.replace(/["']/g, ""), func_name);
			cur_state_idx = -1;

			$('#back').prop('disabled', true);
			$('#next').prop('disabled', false);

			// set the header text
			if (func_name_original === "no function (count)") {

				header_text = dataset_val + ".group("+ col_name + ")";
			} else {
				pre_head_text = dataset_val + ".group("+col_name + ", ";
				post_head_text = ")";
				header_text = dataset_val + ".group("+col_name + ", " + func_name_original + ")";
			}
			$('#code').text(header_text)
			$("#target-group").hide();

			event.preventDefault();

			$('#nav').hide();
			$('#control').show();
		});

		$("#target-pivot" ).submit(function( event ) {
			$("#grouped").empty();
			$('#original').empty();
			var col_name_1 = $('#pivot-column-1').val();
			var col_name_2 = $('#pivot-column-2').val();
			var col_name_3 = $('#pivot-column-3').val();

			var func_name = $('#pivot-function').val();
			func_name_original = $('#pivot-function').val();

			if (col_name_3 === "no argument") {
				func_name = "count";
			}

			if (func_name === "np.average") {
				func_name = "average";
			}

			if (func_name === "np.mean") {
				func_name = "mean";
			}

			if (func_name === "no function (count)") {
				func_name = "count";
			}

			var dataset_val = $('#pivot-dataset').val();
			data = datasets[dataset_val]["data"];
			var dataset_col_order = datasets[dataset_val]["col_order"];
			// build original table from the rows and values

			var ths = dataset_col_order.map(function(x) {
				return "<th>" + x + "</th>"
			}).join("\n");

			var trs = data[dataset_col_order[0]].map(function(item, j) {
				var tds = dataset_col_order.map(function(i) {
					return "<td>" + data[i][j] + "</td>"
				}).join("\n");
				return "<tr>\n" + tds + "\n</tr>";
			}).join("\n");

			var htmlString = "<table><thead><tr>" + ths + "</tr><thead><tbody>" + trs + "<tbody><table";
			$("#original").html(htmlString);

			states = pivot(datasets[dataset_val], col_name_1.replace(/["']/g, ""), col_name_2.replace(/["']/g, ""), col_name_3.replace(/["']/g, ""), func_name);
			cur_state_idx = -1;

			$('#back').prop('disabled', true);
			$('#next').prop('disabled', false);

			// set the header text
			if (func_name_original === "no function (count)" || col_name_3 === "no argument") {
				header_text = dataset_val + ".pivot("+ col_name_1 + ", " + col_name_2 + ")";
			} else {
				pre_head_text = dataset_val + ".pivot(" + col_name_1 + ", " + col_name_2 + ", " + col_name_3 + ", ";
				post_head_text = ")";
				header_text = dataset_val + ".pivot(" + col_name_1 + ", " + col_name_2 + ", " + col_name_3 + ", " + func_name_original + ")";
			}
			$('#code').text(header_text)
			$("#target-pivot").hide();
			// hide the top bar
			$('#nav').hide();
			$('#control').show();
			event.preventDefault();


		});


		$('#reload-button').click(function() {
			location.reload();
			return false;
		});


		$('#next').click(function() {
			if (cur_state_idx < states.length - 1) {
				cur_state_idx = cur_state_idx + 1;
				cur_state = states[cur_state_idx];
				// redraw table
				update(cur_state);
			}

			if (cur_state_idx >= states.length - 1) {
				$('#next').prop('disabled', true);
			}

			if (cur_state_idx >= 0) {
				$('#back').prop('disabled', false);
			}
		})

		$('#back').click(function() {
			if (cur_state_idx > 0) {
				cur_state_idx = cur_state_idx - 1;
				cur_state = states[cur_state_idx];
				// redraw table
				update(cur_state);
			}

			if (cur_state_idx < states.length -1) {
				$('#next').prop('disabled', false);
			}

			if (cur_state_idx <= 0) {
				$('#back').prop('disabled', true);
			}

		})

		function update(state) {
			// possible values
			var text = state["text"];
			if (text === undefined) {
				$('#text').text('\xa0');
			} else {
				$('#text').text(text);
			}

			var command_h = state["command_h"];
			if (command_h === undefined) {
				$('#code').replaceWith("<h2 id=\"code\">" + header_text + "</h2>");
			} else {
				$('#code').replaceWith("<h2 id=\"code\">" + pre_head_text + "<u><b>" + func_name_original + "</b></u>" + post_head_text + "</h2>");
			}

			var o_col_h = state["o_col_h"];
			var o_row_h = state["o_row_h"];
			var o_cell_h = state["o_cell_h"];

			if (o_col_h === undefined) {
				$("#original th").removeClass("highlight-col");
				$("#original td").removeClass("highlight-col");
			} else {
				//Add highlight class to new column
				$("#original th").removeClass("highlight-col");
				$("#original td").removeClass("highlight-col");
			  var index = o_col_h[0];
			  $("#original tr").each(function(i, tr) {
			  	$(tr).find('th').eq(index).addClass("highlight-col");
					$(tr).find('td').eq(index).addClass("highlight-col");
			  });
			}

			if (o_row_h === undefined) {
				$("#original tr").removeClass("highlight-row");
			} else {
				//Add highlight class to new column
				$("#original tr").removeClass("highlight-row");

				var idx = o_row_h.map(function(x) {return x+1;});
				$("#original tr").each(function(j, tr) {
					if (idx.includes(j)) {
						$(tr).addClass("highlight-row");
					}
				});

			}

			if (o_cell_h === undefined) {
				$("#original td").removeClass("highlight-cell");
				$("#original th").removeClass("highlight-cell");
			} else {
				//Add highlight class to new column
				$("#original td").removeClass("highlight-cell");
				$("#original tr").each(function(i, tr) {
			  	$(tr).find('td').each(function(j, td) {
						if (matrixSearch(o_cell_h, [i-1, j])) {
							$(td).addClass("highlight-cell")
						}
					})

					$(tr).find('th').each(function(j, th) {
						if (matrixSearch(o_cell_h, [i-1, j])) {
							$(th).addClass("highlight-cell")
						}
					})

			  });
			}

			var n_data = state["n_data"];
			var n_col_ord = state["n_col_ord"];
			var n_col_h = state["n_col_h"];
			var n_row_h = state["n_row_h"];
			var n_cell_h = state["n_cell_h"];
			var display_as_arrays = state["display_as_arrays"];
			var display_with_function = state["display_with_function"];

			if (n_data === undefined) {
				$("#grouped").html("");
			} else {
				$("#grouped").html("");
				var ths = n_col_ord.map(function(x) {
					return "<th>" + x + "</th>"
				}).join("\n");

				var trs = n_data[n_col_ord[0]].map(function(item, j) {
					var tds = n_col_ord.map(function(key, i) {
						if (n_data[key][j] === undefined) {
							n_data[key][j] = "";
						}
					var value = n_data[key][j];
					if (i !== 0) {
						if (display_as_arrays) {
							value = "["  + formatArrayValues(value) + "]"
						}

						if (display_with_function) {
							value = func_name_original +  "("  + value + ")"
						}
					}

						var td = "<td>" + value + "</td>";
						return td;
					});
					return "<tr>\n" + tds.join("\n") + "</tr>";
				}).join("\n");

				var htmlString = "<table><thead><tr>" + ths + "</tr><thead><tbody>" + trs + "<tbody><table";
				$("#grouped").html(htmlString);

			}



			if (n_row_h === undefined) {
				$("#grouped tr").removeClass("highlight-row");
			} else {
				//Add highlight class to new column
				$("#grouped tr").removeClass("highlight-row");

				var idx = n_row_h.map(function(x) {return x+1;});
				$("#grouped tr").each(function(j, tr) {
					if (idx.includes(j)) {
						$(tr).addClass("highlight-row");
					}
				});

			}

			if (n_col_h === undefined) {
				$("#grouped th").removeClass("highlight-col");
				$("#grouped td").removeClass("highlight-col");
			} else {
				//Add highlight class to new column
				$("#grouped th").removeClass("highlight-col");
				$("#grouped td").removeClass("highlight-col");

			  var index = n_col_h[0];
			  $("#grouped tr").each(function(i, tr) {
			  	$(tr).find('td').eq(index).addClass("highlight-col");
			  });
				$("#grouped tr").each(function(i, tr) {
			  	$(tr).find('th').eq(index).addClass("highlight-col");
			  });
			}

			if (n_cell_h === undefined) {
				$("#grouped td").removeClass("highlight-cell");
				$("#grouped th").removeClass("highlight-cell");
			} else {
				//Add highlight class to new column
				$("#grouped td").removeClass("highlight-cell");
				$("#grouped tr").each(function(i, tr) {
			  	$(tr).find('td').each(function(j, td) {
						if (matrixSearch(n_cell_h, [i-1, j])) {
							$(td).addClass("highlight-cell")
						}
					})
			  });
			}
		}

		$("#group-dataset").change(function(x) {
			var dataset_val = $('#group-dataset').val();
			var col_options = datasets[dataset_val]["col_order"].map(function(x) {
				return '\"' + x + '\"';
			});
			$('#group-column').empty();
			$('#group-column').append(col_options.map(function(x) {
				return "<option>" + x + "</option>";
			}).join("\n"));
		});

		$("#pivot-dataset").change(function(x) {
			var dataset_val = $('#pivot-dataset').val();

			var col_options = datasets[dataset_val]["col_order"].map(function(x) {
				return '\"' + x + '\"';
			});
			$('#pivot-column-1').empty();
			$('#pivot-column-2').empty();
			$('#pivot-column-3').empty();
			$('#pivot-column-1').append(col_options.map(function(x) {
				return "<option>" + x + "</option>";
			}).join("\n"));

			$('#pivot-column-2').append(col_options.map(function(x) {
				return "<option>" + x + "</option>";
			}).join("\n"));

			$('#pivot-column-3').append(col_options.concat(["no argument"]).map(function(x) {
				return "<option>" + x + "</option>";
			}).join("\n"));
		});


		$("#join-dataset").change(function(x) {
			var dataset_val = $('#join-dataset').val();
			var join_cols = datasets[dataset_val]["join-cols"]
			var join_table = datasets[dataset_val]["join-name"];
			$('#join-text').empty();
			$('#join-text').append(
				"<h2>.join(\"" + join_cols[0] + "\", " + join_table + ", \"" + join_cols[0] + "\")</h2>"
			);
		});

		function matrixSearch(arr, x) {
			var contained = false;
			arr.forEach((item, i) => {
				if (JSON.stringify(item) === JSON.stringify(x)) {
					contained = true;
				}
			});
			return contained;

		}

	</script>
</html>
